# ELB (Elastic Load Balancing)

[**Scalability(확장성) & High Availability(고가용성)**](https://www.notion.so/Scalability-High-Availability-b32ccae3a0eb41d78fbbb07b79b5ad37?pvs=21)

### Load Balancing

- 로드 밸런서
    - 서버 혹은 서브넷으로 트래픽을 백엔드나 다운스트림 EC2 인스턴스 또는 서버들로 전달하는 역할

- 로드 밸런싱을 통해 유저들이 각각 다른 EC2 인스턴스에 연결되도록 트래픽을 분산시켜줌
    - 유저들은 자신이 어떤 인스턴스에 연결되어 있는지 알 수 없음
    - 상태 확인(Health Checks) 매커니즘으로 어떤 인스턴스로 트래픽을 보낼 수 없는지 확인가능
    - SSL 종료 가능, 웹 사이트에 암호화된 HTTPS 트래픽 가질 수 있음
    - 쿠키로 고정도 강화 가능
    - 영역에 걸친 고가용성을 가짐
    - 클라우드 내 개인 트래픽과 공공 트래픽 분리 가능

### Elastic Load Balancer

- 관리형 로드 밸런서
- AWS가 관리, 업그레이드, 유지 관리 및 고가용성 책임
- 로드 밸런서 작동 방식 수정할 수 있도록 일부 구성 놉 제공
- 자체 로드 밸런서 마련하는 것보다 저렴
- 다수의 AWS 서비스들과 통합 되어 있음
- 로드 밸런서 보안
    - 유저는 HTTP나 HTTPS를 사용해 어디서든 로드 밸런서에 접근 가능
    - 따라서 로드 밸런서 보안 그룹의 규칙은 아래와 같은 형태가 됨
        - 포트 범위 80, 혹은 443
        - 소스 0.0.0.0 / 0 (어디서든 접속 가능하다는 듯)
    - EC2 인스턴스 보안 규칙은 조금 다름, 로드 밸런서를 통해 들어오는 트래픽만 허용해야 하므로
        - 포트 범위 80, HTTP 트래픽 허용
        - 소스는 로드 밸런서의 보안 그룹으로 연결

- Health Checks
    - Elastic Load Balancer 작동 상태 확인
    - 포트와 라우트에서 이루어짐

### Application Load Balancer

- 7계층, HTTP 전용 로드 밸런서
- 머신 간 다수 HTTP 애플리케이션의 라우팅에 사용 됨
    - 머신들은 target groups로 묶이게 됨
    - redirects 지원 ( HTTP에서 HTTPS로 트래픽을 자동 redirects 하려는 경우 )
    - URL 대상 경로에 기반한 라우팅도 가능
        - ex) [example.com/users](http://example.com/users) & [example.com/posts](http://example.com/posts)
        - users와 posts는 URL 상의 서로 다른 경로, 이들을 target groups 그룹에 redirets 가능
    - URL의 호스트 이름에 기반한 라우팅 가능
        - ex) 로드 밸런서가 [one.example.com](http://one.example.com/) & other.example.comd에 접근 가능하다면
        - 두 개의 다른 target groups에 라우팅 됨
    - 쿼리 문자열과 헤더에 기반한 라우팅 가능
        - ex) [example.com/users?id=123&order-=false가](http://example.com/users?id=123&order-=false%EA%B0%80) 다른 target groups에 라우팅 될 수 있는 것
- 동일 EC2 인스턴스 상의 여러 애플리케이션에 트래픽을 분산
    - ex) containers, ECS
- HTTP/2와 Websocket 지원
- 약자로 ALB
- 마이크로 서비스나 컨테이너 기반 애플리케이션에 가장 좋은 로드 밸런서
    - 도커와 Amazon ECS에 적합
- 포트 매핑 기능이 있어 ECS 인스턴스의 동적 포트로의 리다이렉션을 가능하게 해줌
- 하나의 로드 밸런서로 다수의 애플리케이션 처리 가능

### ALB Target Groups Types

- EC2 인스턴스 (오토 스케일링 그룹에 의해 관리 ) - HTTP
- ECS 작업 - HTTP
- 람다 함수
- IP Address - 사설 IP 주소여야만 함
- 즉, ALB는 여러 Target Groups으로 라우팅 가능
- Health Checks는 Target Groups 레벨에서 이루어짐

### 로드 밸런서 심화 개념

### Network Load Balancer

- L4 로드 밸런서
    - **TCP와 UDP** 트래픽을 다룰 수 있음
    - HTTP를 다루는 L7보다 하위 계층
    - 초당 수백만 건의 요청 처리 가능
    - ALB에 비해 지연 시간 짧음, ALM = 400ms, NLB = 100ms
    - 가용 영역별로 하나의 고정 IP를 가짐
    - 탄력적 IP주소를 각 AZ에 할당 가능
    - 여러 개의 고정 IP를 가진 애플리케이션을 노출할 때 유용
    - ex) 1~3개의 IP로만 액세스할 수 있는 애플리케이션을 만들라는 문제가 나오면 NLB를 선택 (TCP, UDP, elastic IP)
    - 프리 티어 아님


### NLB Target Groups Types

- EC2 인스턴스
- IP 주소 - 반드시 하드코딩, 프라이빗 IP
- ALB 앞에 사용 가능
    - NLB를 통해 고정 IP 얻을 수 있고 ALB 덕분에 HTTP 유형의 트래픽 처리하는 규칙 얻을 수 있음
- Health Check
    - TCP, HTTP, HTTPS Protocols 지원

### Gateway Load Balancer

- 가장 최근 로드 밸런서
- 네트워크 트래픽 분석
- L3 계층
- GWLB 2가지 기능
    - Trasparent Network Gateway
        - VCP 모든 트래픽이 GWLB의 sing entry/exit을 통과하기 때문
    - 로드 밸런서
        - 가상 어플라이언스 집합에 트래픽을 분산해줌
- 6081번 포트의 GENEVE 프로토콜을 사용
- GWLB는 배포 및 확장, AWS의 타사 네트워크 가상 어플라이언스의 플릿 관리에 사용
- **네트워크의 모든 트래픽이 방화벽을 통과하게 하거나 침입 탐지 및 방지 시스템 ( IDPS ) 에 사용**
- IDPS나 심층 패킷 분석 시스템 또는 일부 페이로드 수정 가능
    - 단, 네트워크 수준에서 가능

### GWLB Target Groups Types

- 타사 어플라이언스임
    - EC2 인스턴스
    - IP 주소 - 프라이빗 IP

### Elastic Load Balancer Sticky Session ( Session Affinity )

- 고정성 혹은 고정 세션을 실행하는 것
- 로드 밸런서에 2가지 요청을 하는 클라이언트가 요청에 응답하기 위해 백엔드에 동일한 인스턴스를 갖는 것
- 2개의 EC2 인스턴스와 3개의 클라이언트가 있는 ALB와 같은 것

- 1번 클라이언트가 요청을 생성해 첫 번째 EC2 인스턴스로 가면 두 번째 요청시에도 로드밸런서를 통해 동일한 인스턴스로 이동
- 2번 클라이언트, 3번 클라이언트도 동일하게 로드 밸런서가 두 번째 인스턴스와 통신하면 해당 인스턴스로 이동
- ALB에서 설정 가능
- '쿠키'라는 원리를 통해 가능
    - 클라이언트에서 로드 밸런서로의 요청이 일부 전송되는 것
    - 고정성과 만료 기간이 있음
    - '쿠키'가 만료 되면 클라이언트가 다른 EC2 인스턴스로 리디렉션 됨
- 세션 만료시에는 사용자 로그인과 같은 중요한 정보를 취하는 세션 데이터를 잃지 않기 위해 사용자가 동일한 백엔드 인스턴스에 연결됨
- 고정성을 활성화하면 백엔드 EC2 인스턴스 부하에 불균형을 초래할 수 있음, 일부 인스턴스는 고정 사용자를 갖게 됨
- 쿠키의 종류
    1. Application-based Cookies (애플리케이션 기반)

       1-1. custom cookie

        - Generated by the target
        - 애플리케이션에 필요한 모든 사용자 정의 속성을 포함 가능
        - 애플리케이션에서 기간 지정
        - 쿠키 이름은 각 Target group 별로 개별 지정
        - Don't use AWSALB, AWSALBAPP, or AWSALBTG (ELB에서 사용하기 때문)

       1-2.Application cookie

        - Generated by the load balancer
        - Cookie name is AWSALBAPP
    2. Duration-based Cookies (기간 기반)
    - Cookie generated by the load balancer
    - Cookie name is AWSALB for ALB, AWSELB for CLB
    - 특정 기간을 기반으로 만료, 로드 밸런서 자체에서 생상

### Cross-Zone Load Balancing (교차영역 로드 밸런싱)

- 교차 영역 로드 밸런싱을 쓰면, 각각의 로드 밸런서 인스턴스가 모든 가용 영역에 등록 된 인스턴스에 트래픽을 50씩 균등하게 분배
    - 인스턴스 수가 10개니까 균등하게 10씩 할당 받음

- Cross Zone Load Balancing 비활성화인 경우
  - 영역을 교차하지 않고 부하를 분산, Elastic 로드 밸런서 노드의 인스턴스로 분산
  - 트래픽 분산 방법은 사진과 같음, 특정 영역에 트래픽이 더 분산됨
  - 정답은 없다, 상황에 맞게 고려해서 사용하면 된다

- ALB는 기본적으로 교차 영역 로드 밸런싱이 활성화
    - 따라서 AZ 간의 데이터 이동에 비용이 들지 않음
- NLB와 GWLB는 기본적으로 교차 영역 로드 밸런싱이 비활성화
    - 활성화 하려면 비용 지불해야 함, AZ 사이 데이터를 옮기려면 비용이 발생하므로
- # ELB Connection Draining (연결 드레이닝)

**Connection Draining (⭐️)**

- Deregistration Delay - for ALB & NLB
- 인스턴스가 등록 취소, 혹은 비정상 상태에 있을 때 인스턴스에 어느 정도의 시간을 주어 활성 요청(in-flight requests)를 완료할 수 있도록 하는 기능
- Connection Draining되면 ELB는 등록 취소 중인 EC2 인스턴스로 새로운 요청을 보내지 않음

- Connection Draining 파라미터는 매개변수로 표시 가능
    - 1 to 3600 second (default : 300 seconds )
    - 이 값을 0으로 설정하면 비활성화
    - 짧은 요청의 경우 낮은 값으로 설정하면 좋음
    - 그래야 EC2 인스턴스가 빠르게 드레이닝되고, 오프라인 상태가 되어 교체 작업을 할 수 있음